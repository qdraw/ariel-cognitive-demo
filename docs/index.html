<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Emotion-dection and Classify - powered by Colours AI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="css/bootstrap.min.css">
		<link rel="stylesheet" href="css/dropzone_basic.css">
		<link rel="stylesheet" href="css/style.css">
		<link rel="icon" type="image/png" href="img/favicon.png" />
		<meta name="csrf-token" content="">
	</head>
<body>
	<div id="header">
		<img src="img/colours.gif" alt="Colours logo" height="50">
	</div>

	<div class="preloader">
		<img src="img/preloader.svg" width="100px" height="100px">
	</div>

	<h1>Emotion-dection</h1>

	<form id="upload-widget" action="upload" method="post" class="dropzone">
		<div class="fallback">
			<input name="file" type="file" />
		</div>
	</form>

	<div id="image">
	</div>

	<script type="text/javascript" src="js/dropzone.js"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>

	<script type="text/javascript">

	Dropzone.autoDiscover = false;

	document.addEventListener("DOMContentLoaded", function(event){

		getConfig();

		if (document.querySelectorAll(".fallback > input:nth-child(1)").length >= 1) {
			document.querySelector(".fallback > input:nth-child(1)").style.display = "none";
		}

		function getConfig() {

			var xhr = new XMLHttpRequest();
			xhr.open('GET', "config.json", true);
			xhr.onload = function () {
				if (xhr.status === 200 || xhr.status === 304) {
					try {
						data = JSON.parse(xhr.responseText);
					} catch (e) {
						data = undefined;
					}

					if (data !== undefined) {
						getBackendServer(data.server + "init" ,data.inittoken);
						document.querySelector("#upload-widget").action = data.server + "upload";
					}

				}
			};
			xhr.send(null);
		}

		function getBackendServer(server,inittoken) {
			console.log(server);
			var xhr = new XMLHttpRequest();
			xhr.open('POST', server, true);
			xhr.setRequestHeader("bearer", inittoken);

			xhr.onload = function () {
				if (JSON.parse(xhr.responseText).length === 64) {
					console.log(xhr.responseText);
					document.querySelectorAll('meta[name=csrf-token]')[0].getAttributeNode('content').value = JSON.parse(xhr.responseText);
					uploadWidget();
				}
			};
			xhr.send(null);
		}

		function uploadWidget() {
			var uploader = new Dropzone('#upload-widget', {
				paramName: 'file',
				maxFilesize: 3, // MB
				maxFiles: 1,
				thumbnailWidth: 1000,
				thumbnailHeight: null,
				dictDefaultMessage: 'Drag an image here to upload, or click to select one',
				headers: {
					'x-csrf-token': document.querySelectorAll('meta[name=csrf-token]')[0].getAttributeNode('content').value,
				},
				acceptedFiles: 'image/jpeg',
				accept: function(file, done) {
					file.acceptDimensions = done;
					file.rejectDimensions = function() {
						done('The image must be at least 640 x 480px')
					};
				}
			});
			uploader.on('addedfile', function( file){
				console.log(file);
				// start upload
			});

			// uploader.on("sending", function(file, xhr, formData) {
			// 	// formData.append("bearer", file.height);
			// 	// formData.append("width", file.width);
			// });

			uploader.on('thumbnail', function(file, dataUrl) {
				// console.log(dataUrl);
				if ( file.width < 640 || file.height < 480 ) {
					file.rejectDimensions();
				}
				if ( file.width >= 640 || file.height >= 480 ) {
					file.acceptDimensions();
				}
			});

			uploader.on('success', function( file, resp ){

				waitForCognitive(resp.filename);

				document.querySelector(".dz-success-mark").style.display = "none";

				rotateImage(document.querySelector(".dz-image > img:nth-child(1)").src, resp.orientation, function (base64) {
					document.querySelector(".dz-image > img:nth-child(1)").src = base64;
				})

			});
		}

		function waitForCognitive(hash) {
			var intervalForCognitive = setInterval(function(){
				var xhr = new XMLHttpRequest();
				xhr.open('POST', document.querySelector("#upload-widget").action.replace("upload","status"), true);
				xhr.setRequestHeader("bearer", document.querySelectorAll('meta[name=csrf-token]')[0].getAttributeNode('content').value);
				xhr.setRequestHeader("filename", hash);
				xhr.onload = function () {

					if (xhr.responseText !== "false") {
						clearInterval(intervalForCognitive);
						showData(xhr.responseText);
					}
				};
				xhr.send(null);

			}, 1234);
		}

		function rotateImage(srcBase64, srcOrientation, callback) {
			var img = new Image();

	  		img.onload = function() {
				var width = img.width,
				height = img.height,
				canvas = document.createElement('canvas'),
				ctx = canvas.getContext("2d");

				// set proper canvas dimensions before transform & export
				if (4 < srcOrientation && srcOrientation < 9) {
					canvas.width = height;
					canvas.height = width;
				} else {
					canvas.width = width;
					canvas.height = height;
				}

				// transform context before drawing image
				switch (srcOrientation) {
					case 2: ctx.transform(-1, 0, 0, 1, width, 0); break;
					case 3: ctx.transform(-1, 0, 0, -1, width, height ); break;
					case 4: ctx.transform(1, 0, 0, -1, 0, height ); break;
					case 5: ctx.transform(0, 1, 1, 0, 0, 0); break;
					case 6: ctx.transform(0, 1, -1, 0, height , 0); break;
					case 7: ctx.transform(0, -1, -1, 0, height , width); break;
					case 8: ctx.transform(0, -1, 1, 0, 0, width); break;
					default: break;
				}

				// draw image
				ctx.drawImage(img, 0, 0);

				// export base64
				callback(canvas.toDataURL());
			};

			img.src = srcBase64;
		}


		function showData(response) {
			moveUploader();
			function moveUploader() {
				document.querySelector("#upload-widget").style.display = "none";
				var img = document.createElement('img')
				img.src = document.querySelector(".dz-image > img:nth-child(1)").src
				document.querySelector('#image').appendChild(img);
				document.querySelector("#image").style.display = "block";
			}
			console.log(response);
			document.querySelector("#image").innerHTML += response;

		}

	});





	</script>

  </body>
</html>
